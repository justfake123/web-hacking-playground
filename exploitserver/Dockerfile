FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Add security updates and explicitly upgrade vulnerable perl-base
RUN apt-get update -y && \
    apt-get install -y wget gnupg unzip python3 python3-pip libglib2.0-0 libnss3 libxcb1 libgconf-2-4 libfontconfig1 && \
    apt-get install -y perl-base=5.34.0-3ubuntu1.5 && \
    apt-get dist-upgrade -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Chrome (using safer HTTPS mirror)
RUN wget https://mirror.cs.uchicago.edu/google-chrome/pool/main/g/google-chrome-stable/google-chrome-stable_114.0.5735.90-1_amd64.deb && \
    dpkg -i google-chrome-stable_114.0.5735.90-1_amd64.deb || apt-get -f install -y && \
    rm google-chrome-stable_114.0.5735.90-1_amd64.deb

# Install matching chromedriver
RUN wget http://chromedriver.storage.googleapis.com/114.0.5735.90/chromedriver_linux64.zip && \
    unzip chromedriver_linux64.zip -d /usr/local/bin/ && \
    rm chromedriver_linux64.zip

ENV DISPLAY=:99

COPY . /app
WORKDIR /app

RUN pip3 install --no-cache-dir -r requirements.txt

ENTRYPOINT ["python3"]
CMD ["app.py"]
